<analysis>**original_problem_statement:**
The user wants to build a full-stack web application to score a burnout competition.

**PRODUCT REQUIREMENTS:**
1.  **Database**: Load competitor details from a database (MongoDB).
2.  **Authentication**: A login function for judges and an admin.
3.  **Scoring Categories**:
    *   Tip In, Instant Smoke, Constant Smoke & Volume of Smoke, Driving Skill (0.5 increments).
    *   Tyre Popped (integer increments).
4.  **Penalties**:
    *   Cumulative -5 points for: Reversing, Stopping, Contact with Barrier, Small Fire.
    *   One-time -10 points for: Failing to drive off pad, Large Fire.
    *   A Disqualified option that nullifies the total score.
5.  **Score Management**:
    *   Judges can review and edit their own submitted scores.
    *   Admins can edit and delete individual scores from a filterable, sortable list.
6.  **Data Management**:
    *   Admin interface to add/edit/delete competitors, judges, and classes. Competitor management includes an  field.
    *   Admin UI to reset scores, competition data, or the entire database.
    *   Bulk import competitor data via CSV, including email addresses.
    *   Download all scoring data.
7.  **Events & Rounds**:
    *   Create Events with a name, date, and active status.
    *   Rounds have a name, status, and a Minor Round checkbox.
8.  **Judge UI/UX**:
    *   Advanced competitor selection (class filter, car number search).
    *   Sortable competitor list (by number or name).
9.  **Leaderboard & Reporting**:
    *   A dedicated leaderboard page with filtering (total/average score, minor rounds).
    *   A printable report from the leaderboard, styled to match user examples.
    *   Admin can upload a logo to appear on reports.
10. **Email Integration**:
    *   Admin settings to configure an SMTP server.
    *   Ability to send individual and bulk reports to competitors' emails.
    *   Track which competitors have been emailed.
11. **Scoring Validation**:
    *   An  flag for judges to control who is scoring an event.
    *   Admin dashboard displays alerts for scoring errors (e.g., a competitor has missing scores from active judges or duplicate scores).

**User's preferred language**: English

**what currently exists?**
A comprehensive full-stack burnout scoring application using FastAPI, React, and MongoDB. The application features role-based authentication (admin/judge), extensive admin dashboards for managing events, rounds, classes, competitors, and scores. The admin can configure application settings, including a company logo, website URL, and SMTP credentials for sending email reports. The system includes scoring validation to flag missing or duplicate scores on the admin dashboard and allows for individual and bulk emailing of styled reports to competitors.

**Last working item**:
- Last item agent was working: The user reported that the bulk email report incorrectly included scores from all rounds for a competitor, and the total/average scores were calculated across all rounds instead of being specific to the relevant round. The agent attempted to fix this by updating the backend.
- Status: IN PROGRESS
- Agent Testing Done: N
- Which testing method agent to use? both. The backend logic needs verification, and the frontend must be updated to send the correct payload to the modified backend endpoint.
- User Testing Done: N

**All Pending/In progress Issue list**:
- **Issue 1: Bulk email content is incorrect (P0)**
    - **Description**: The bulk email functionality generates a report with scores from all rounds, and the summary statistics (total/average) are calculated across all those rounds. The report should be scoped to a single, specific round for each competitor.
    - **Attempted fixes**: The agent updated the backend (). It modified the  function to accept a  and filter scores accordingly. It also updated the  endpoint to process a list of items, each containing a  and . However, the frontend was not updated to send this new payload structure.
    - **Next debug checklist**:
        - **File**: 
        - **Method**:  within the  component.
        - **Action**: Modify the function to construct the request body as an array of objects () by mapping over the  state, instead of just an array of  strings.
    - **Why fix this issue and what will be achieved with the fix?**: This fix is critical for the email feature's correctness. It will ensure that competitors receive accurate, round-specific reports, preventing confusion.
    - **Status**: IN PROGRESS
    - **Is recurring issue?**: N
    - **Should Test frontend/backend/both after fix?**: Both

**In progress Task List**:
None.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
  - **P1 - UI/UX Refinement**: The user might request further UI/UX tweaks based on usage.
- **Future Tasks:**
  - **P2 - Code Refactoring**: Break down monolithic files like  and  into smaller, more manageable modules to improve maintainability.
  - **P2 - Multi-event Support & Historical Archives**: Implement features to better manage data across multiple, separate events and archive past event data.

**Completed work in this session**
- **Feature: Leaderboard Reporting & Logo Upload**:
    - Implemented UI and backend for uploading a logo and setting a website/organization name (, ).
    - Redesigned the print report to match user-provided PDF examples, including the logo, event details, and improved styling ().
    - Fixed the date format in reports to  and separated the event name and date onto different lines for better formatting.
- **Feature: Judge Management & Scoring Validation**:
    - Added an Active toggle for judges to control participation per event (, ).
    - Implemented a scoring validation system that displays alerts on the admin dashboard for missing or duplicate scores from active judges (, ).
- **Feature: New Penalties & Score Editing**:
    - Added a Disqualified penalty toggle that zeroes out a competitor's score (, , ).
    - Implemented a feature for admins to edit any score field from the Scores tab (, ).
- **Feature: Full Email Integration**:
    - Created UI for SMTP configuration in Admin settings ().
    - Implemented backend logic to save, test, and send emails via SMTP ().
    - Added UI to track and display scores pending email, with buttons for sending individual and bulk emails.
    - Added an  field to the competitor model and all related admin UIs (create, edit, bulk import).
- **Bug Fixes**:
    - **Print Logo**: Resolved an issue where the logo wouldn't show in the print preview by ensuring the image was loaded before triggering the print dialog.
    - **Leaderboard Persistence**: Made leaderboard filters (score type, show scores) persistent using .
    - **Toggle Alignment**: Fixed a CSS issue causing judge Active toggles to be misaligned.
    - **Email Transport Error**: Fixed a lines too long for transport SMTP error by encoding the HTML email body as base64.
    - **Email Anonymity**: Anonymized judge names in email reports to Judge 1, Judge 2, etc.
    - **SMTP Debugging**: Improved SMTP error handling to provide clearer feedback on connection/authentication failures.

**Earlier issues found/mentioned but not fixed**
None.

**Known issue recurrence from previous fork**
None.

**Code Architecture**


**Key Technical Concepts**
- **Frontend**: React, , , Tailwind CSS, ,  for toasts.
- **Backend**: Python, FastAPI,  (for async MongoDB), Pydantic,  (for JWT),  (for hashing),  (for email),  (for rate limiting).
- **Database**: MongoDB.
- **State Management**: React , , and  for persisting UI state.

**key DB schema**
- **users**: 
- **competitors**: 
- **classes**: 
- **events**: 
- **rounds**: 
- **scores**: 
- **settings**: New key-value collection for storing , , , and encrypted .

**changes in tech stack**
- Added  and  to backend dependencies.

**All files of reference**
- : The single backend file containing all API endpoints and business logic. Significantly expanded this session.
- : The main admin interface. Significantly expanded with new tabs, dialogs, and state management for all new features.
- : Updated for improved print report styling and UI state persistence.
- : Updated to include the Disqualified penalty.
- : Created and updated to track project requirements and progress.

**Areas that need refactoring**:
-  and  are extremely monolithic. Their size and complexity are hindering development and increasing the risk of bugs. They should be broken down into smaller, single-responsibility modules (e.g., API routes in the backend, panel components in the frontend).

**key api endpoints**
- **Settings & Email**:
  - : Uploads a logo.
  - : Manages website URL and organization name.
  - : Manages SMTP configuration.
  - : Tests the SMTP connection.
  - : Sends a single competitor report via email.
  - : Sends emails to multiple competitors.
- **Scoring & Admin**:
  - : Retrieves a list of validation errors (missing/duplicate scores).
  - : Sets a judge's active status.
  - : Allows an admin to edit a complete score record.
  - : Gets a list of competitors who are fully scored but haven't been emailed.

**Critical Info for New Agent**
- **Resume Here**: The immediate priority is fixing the bulk email feature. You must modify the  function in  to send the correct payload () to the backend.
- **Code Health**: The  and  files are unmanageably large. After fixing the current issue, strongly propose a refactoring task to the user to improve the project's long-term health.
- **User Interaction**: The user is responsive and provides clear, feature-rich requests. Continue the pattern of breaking down requests, confirming the plan, and delivering incrementally.

**documents and test reports created in this job**
- 
- 
- 
- 
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User**: Asks to add a Disqualified penalty, email tracking, and admin score editing. **Status: Completed**.
2.  **User**: Asks to fix the date format on reports and begin work on the email function. **Status: Completed**.
3.  **User**: Reports that connecting to their SMTP server is failing and requests a bulk send option. **Status: Completed**.
4.  **User**: States that the competitor table and import/edit features need an email address field. **Status: Completed**.
5.  **User**: Reports a message has lines too long error with bulk emails and asks for judge names to be anonymized (e.g., Judge 1). **Status: Completed**.
6.  **User**: Acknowledges credit renewal and asks the agent to continue fixing the email issues. **Status: Completed**.
7.  **User**: Reports that when a bulk email is sent, it includes scores from all rounds, and the total/average score is for all rounds, not just one. **Status: In Progress**.

**Project Health Check:**
- **Broken**: The bulk email feature is functionally broken. The frontend sends an incorrect payload, preventing the recently implemented backend logic from working as intended.
- **Mocked**: None.

**3rd Party Integrations**
- **Email (SMTP)**: A generic SMTP integration is implemented, allowing the user to configure any standard SMTP server to send emails. It does not use a specific third-party email service like SendGrid.

**Testing status**
- **Testing agent used after significant changes**: YES. The testing agent was used successfully up to  to validate features before the most recent user feedback.
- **Troubleshoot agent used after agent stuck in loop**: NO.
- **Test files created**:
  - 
  - 
  - 
  - 
- **Known regressions**: The bulk email feature has a functional regression due to mismatched frontend/backend payloads.

**Credentials to test flow:**
- **Admin**:  / 
- **Judge**: Create a new judge via the admin panel to ensure you have valid credentials. The password for  was previously invalid.

**What agent forgot to execute**
The agent failed to complete the fix for the bulk email content. After correctly modifying the backend API to expect a more detailed payload (), it did not update the frontend  function to send data in this new format. This left the feature in a broken state.</analysis>
